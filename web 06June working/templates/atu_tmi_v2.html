<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="static/images/glos_favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLOS::ATU<>TMI v2</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="../static/css/styles.css" rel="stylesheet">
  <script src="/static/js/tmi-browse.js"></script>

</head>
<body>
<!--<div class="container-fluid">-->
<div class="container">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <img src="/static/images/glos_wordmark.jpg" alt="GLOS Logo" height="32">
      </a>
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/explore">Concept Matcher</a></li>
<!--          <li class="nav-item"><a class="nav-link" href="/atu_tmi">ATU&lt;&gt;TMI</a></li>-->
          <li class="nav-item"><a class="nav-link" href="/atu_tmi_v2">ATU/TMI</a></li>
          <li class="nav-item"><a class="nav-link disabled-link" href="/mapping">Mapping</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <h4>ATU ↔ TMI: Cross-walking the canonical folkloric indexes
        </h4>
      </div>
    </div>

    <!-- Tab buttons -->
    <div class="tab-buttons">
      <div class="tab-button active" data-tab="search">Search</div>
      <div class="tab-button" data-tab="browse">Browse</div>
    </div>

    <!-- Content area -->
    <div class="content-area">
      
      <!-- Search tab content -->
      <div class="search-content">
        <div class="row">
          <!-- Left side: Search -->
          <div class="col-md-5">
            <!-- Radio buttons above search -->
            <div class="mode-selector mb-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="searchMode" id="atuMode" value="atu" checked>
                <label class="form-check-label" for="atuMode">
                  ATU tale types
                </label>
              </div>
              <span class="mx-2" style="color: #336699;">▶</span>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="searchMode" id="tmiMode" value="tmi">
                <label class="form-check-label" for="tmiMode">
                  Thompson motifs
                </label>
              </div>
            </div>
            
            <div class="search-container">
              <input type="text" class="form-control" id="searchInput"
                     placeholder="Search..." autocomplete="off">
              <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>
          </div>
          
          <!-- Right side: Results -->
          <div class="col-md-7">
            <div id="resultArea">
              <div id="indexHeader" class="mb-1">
                <h5 id="indexTitle">The Types of International Folktales (ATU)</h5>
                <p id="indexAuthor">Hans-Jörg Uther, 2011</p>
              </div>
              <div id="resultContent">
                <p class="text-muted">Enter a word or ATU ID, e.g. <strong>dragon</strong> or <strong>1305</strong> then select one to find related TMI motif(s).</p>
                <img src="static/images/ATU_cover.jpg" alt="ATU cover" height="300">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Browse tab content -->
      <div class="browse-content">
        <div class="row">
          <div class="col-md-5">
            <div class="mode-selector mb-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="browseMode" id="browseAtuMode" value="atu" checked>
                <label class="form-check-label" for="browseAtuMode">
                  ATU tale types
                </label>
              </div>
              <span class="mx-2" style="color: #336699;">▶</span>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="browseMode" id="browseTmiMode" value="tmi">
                <label class="form-check-label" for="browseTmiMode">
                  Thompson motifs
                </label>
              </div>
            </div>
            
            <div id="browseHierarchy">
              <div id="atuHierarchy">
                <p class="text-muted">Loading ATU hierarchy...</p>
              </div>
              <div id="tmiHierarchy" style="display: none;">
                <p class="text-muted">TMI hierarchy coming soon...</p>
              </div>
            </div>
          </div>
          <div class="col-md-7">
            <div id="browseResults">
              <div id="browseIndexHeader" class="mb-3">
                <h5 id="browseIndexTitle">The Types of International Folktales (ATU)</h5>
              </div>
              <div id="browseResultContent">
                <p class="text-muted">Select a category to browse...</p>
                <img src="static/images/ATU_cover.jpg" alt="ATU cover" height="300">
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
<!-- Reusable Modal for Cross-Reference Details -->
<div class="modal fade" id="crossRefeatuModerenceModal" tabindex="-1" aria-labelledby="crossReferenceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="crossReferenceModalLabel">Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="crossReferenceModalBody">
        <p class="text-muted">Loading...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
$(document).ready(function() {
  let searchTimeout;
  let currentMode = 'atu';
  let browseMode = 'atu';
  let atuHierarchyLoaded = false;
  let tmiHierarchyLoaded = false;

  // Tab switching
  $('.tab-button').click(function() {
    const tab = $(this).data('tab');
    
    // Update tab appearance
    $('.tab-button').removeClass('active');
    $(this).addClass('active');
    
    // Show/hide content
    if (tab === 'search') {
      $('.search-content').show();
      $('.browse-content').hide();
    } else {
      $('.search-content').hide();
      $('.browse-content').show();
      // Load browse content if not already loaded
      if ($('#atuHierarchy').html().includes('Loading')) {
        loadATUHierarchy();
      }
    }
  });

  // Browse mode radio buttons
  $('input[name="browseMode"]').change(function() {
    browseMode = $(this).val();
    updateBrowseDisplay();
  });

  function updateBrowseDisplay() {
    if (browseMode === 'atu') {
        $('#browseIndexTitle').text('The Types of International Folktales (ATU)');
        $('#atuHierarchy').show();
        $('#tmiHierarchy').hide();
        $('.browse-content .mode-selector span').html('▶').css('color', '#336699');

        if (!atuHierarchyLoaded) {
            loadATUHierarchy();
        }
    } else {
        $('#browseIndexTitle').text('Thompson Motif-Index (TMI)');
        $('#atuHierarchy').hide();
        $('#tmiHierarchy').show();
        $('.browse-content .mode-selector span').html('◀').css('color', '#336699');

        // Use the new TMI browser
        if (!tmiHierarchyLoaded) {
            tmiBrowser.loadTMICategories();
            tmiHierarchyLoaded = true;
        }
    }

    if (browseMode === 'tmi') {
        $('#browseResultContent').html(`
            <div class="browse-explanation">
                <p class="text-muted mb-2">Displaying only motifs that have been cross-referenced in the ATU index.</p>
                <p class="text-muted">Select a category to begin browsing...</p>
                <img src="static/images/TMI_cover.jpg" alt="TMI cover" height="300">
            </div>
        `);
    } else {
        $('#browseResultContent').html('<p class="text-muted">Select a category to browse...</p>' +
          '<img src="static/images/ATU_cover.jpg" alt="ATU cover" height="300">');
    }
}

  // Radio button handling for search
  $('input[name="searchMode"]').change(function() {
    currentMode = $(this).val();
    updateIndexHeader();
    updateDirectionArrow();
    clearResults();
    $('#searchInput').val('').focus();
  });

  function updateDirectionArrow() {
    const arrow = $('.search-content .mode-selector span');
    if (currentMode === 'atu') {
      arrow.html('▶').css('color', '#336699');
    } else {
      arrow.html('◀').css('color', '#336699');
    }
  }

  function updateIndexHeader() {
    if (currentMode === 'atu') {
      $('#indexTitle').text('The Types of International Folktales (ATU)');
      $('#indexAuthor').text('Hans-Jörg Uther, 2011');
      $('#searchInput').attr('placeholder', 'Search tale types...');
    } else {
      $('#indexTitle').text('Motif-Index of Folk-Literature (TMI)');
      $('#indexAuthor').text('Stith Thompson, 1960');
      $('#searchInput').attr('placeholder', 'Search motifs...');
    }
  }

  function clearResults() {
    $('#searchResults').hide();
    if (currentMode === 'atu') {
      $('#resultContent').html('<p class="text-muted">Enter a word or ATU ID, e.g. <strong>dragon</strong> or <strong>1305</strong> then select one to find related TMI motif(s).</p>' +
        '<img src="static/images/ATU_cover.jpg" alt="ATU cover" height="300">');
    } else {
      $('#resultContent').html('<p class="text-muted">Enter a word or TMI ID, e.g. <strong>dragon</strong> or <strong>1846.4</strong> then select one to find related ATU tale type(s)</p>' +
        '<img src="static/images/TMI_cover.jpg" alt="TMI cover" height="300">');
    }
  }

  // Search functionality
  $('#searchInput').on('input', function() {
    const query = $(this).val().trim();
    
    if (query.length < 2) {
      $('#searchResults').hide();
      return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      performSearch(query);
    }, 300);
  });

  function performSearch(query) {
    const endpoint = currentMode === 'atu' ? '/search_types' : '/search_motifs';
    
    $.get(`${endpoint}?q=${encodeURIComponent(query)}&limit=10`)
      .done(function(data) {
        displaySearchResults(data);
      })
      .fail(function() {
        $('#searchResults').html('<div class="search-result-item text-danger">Search error</div>').show();
      });
  }

  function displaySearchResults(data) {
    if (data.length === 0) {
      $('#searchResults').html('<div class="search-result-item">No results found</div>').show();
      return;
    }

    let html = '';
    data.forEach(item => {
      if (currentMode === 'atu') {
        html += `<div class="search-result-item" onclick="selectTaleType('${item.type_id}')">
                   <strong>ATU ${item.type_id}</strong> – ${item.label}
                 </div>`;
      } else {
        html += `<div class="search-result-item" onclick="selectMotif('${item.motif_id}')">
                   <strong>${item.motif_id}</strong>: ${item.text.substring(0, 80)}${item.text.length > 80 ? '...' : ''}
                   <span class="badge bg-primary float-end">${item.type_count || 0}</span>
                 </div>`;
      }
    });
    
    $('#searchResults').html(html).show();
  }

  // Selection handlers
  window.selectTaleType = function(typeId) {
  $('#searchResults').hide();
  $('#searchInput').val('').attr('placeholder', 'Search tale types...');
  loadTaleTypeDetails(typeId);
  };

  window.selectMotif = function(motifId) {
    $('#searchResults').hide();
    $('#searchInput').val('').attr('placeholder', 'Search motifs...');
    loadMotifDetails(motifId);
  };

  function loadTaleTypeDetails(typeId) {
    // Get tale type details and its motifs
    Promise.all([
      $.get(`/get_type_details/${typeId}`),
      $.get(`/get_motifs_for_type/${typeId}`)
    ]).then(([typeDetails, motifs]) => {
      displayTaleTypeResult(typeId, typeDetails, motifs);
    }).catch(() => {
      $('#resultContent').html('<p class="text-danger">Error loading tale type details</p>');
    });
  }

  function loadMotifDetails(motifId) {
    // Get motif details and its tale types
    Promise.all([
      $.get(`/get_motif_details/${motifId}`),
      $.get(`/get_types_for_motif/${motifId}`)
    ]).then(([motifDetails, types]) => {
      displayMotifResult(motifId, motifDetails, types);
    }).catch(() => {
      $('#resultContent').html('<p class="text-danger">Error loading motif details</p>');
    });
  }

  function displayTaleTypeResult(typeId, details, motifs) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<p class="cultural-refs-atu">[${terms.join(', ')}${remaining > 0 ? `, ... <a href="#"><i>${remaining} more</i></a>` : ''}]</p>`;
    }

    let html = `
      <div class="result-item">
        <h5>ATU ${typeId} - ${details.label} ${culturalRefs}</h5>
        <p>${details.text || ''}</p>
        
        <div class="motif-list">
          <h6>Motifs:</h6>
    `;

    motifs.forEach(motif => {
      let motifCulturalRefs = '';
      if (motif.ref_terms && motif.ref_terms.trim()) {
        motifCulturalRefs = ` <span class="cultural-refs">[${motif.ref_terms}]</span>`;
      }
      html += `<div class="motif-item">
                 <span class="clickable-motif" onclick="loadMotifModalFromTaleType('${motif.motif_id}', '${typeId}')">
                   <strong>${motif.motif_id}</strong> ${motif.text}
                 </span>${motifCulturalRefs}
               </div>`;
    });

    html += '</div></div>';
    $('#resultContent').html(html);
  }

  function displayMotifResult(motifId, details, types) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
    }

    let html = `
      <div class="result-item">
        <h5>TMI ${motifId}: ${details.text} ${culturalRefs}</h5>
        
        <div class="motif-list">
          <h6>Tale Types (${types.length}):</h6>
    `;

    types.forEach(type => {
      let typeCulturalRefs = '';
      if (type.ref_terms && type.ref_terms.trim()) {
        typeCulturalRefs = ` <span class="cultural-refs">[${type.ref_terms}]</span>`;
      }
      html += `<div class="motif-item">
                 <span class="clickable-tale-type" onclick="loadTaleTypeModal('${type.type_id}')">
                   <strong>ATU ${type.type_id}</strong> – ${type.label}
                 </span>${typeCulturalRefs}
               </div>`;
    });

    // Add cross-reference logic here for multiple tale types
    // if (types.length > 1) {
    //   html += `<div class="cross-reference">
    //              Also appears in ${types.length} tale types
    //            </div>`;
    // }

    html += '</div></div>';
    $('#resultContent').html(html);
  }

  // Load ATU hierarchy for browse tab
  function loadATUHierarchy() {
    fetch('/get_atu_hierarchy')
      .then(response => response.json())
      .then(data => {
        const hierarchyHtml = buildATUAccordion(data, 'browse-accordion-root');
        $('#atuHierarchy').html(hierarchyHtml);
        atuHierarchyLoaded = true;
      })
      .catch(error => {
        console.error('Error loading ATU hierarchy:', error);
        $('#atuHierarchy').html('<p class="text-danger">Error loading hierarchy</p>');
      });
  }

  function buildATUAccordion(nodes, parentId, level = 0) {
    let html = `<div class="accordion" id="${parentId}">`;

    nodes.forEach((node, index) => {
      const accordionId = `${parentId}-${index}`;
      const hasChildren = node.children && node.children.length > 0;
      const parentAttribute = level === 0 ? `data-bs-parent="#${parentId}"` : '';

      html += `
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}"
                    ${parentAttribute}
                    ${hasChildren ? '' : `onclick="loadTypesInRange('${node.type_range}', 'collapse-${accordionId}')"`}>
              ${node.label} (${node.type_range})
            </button>
          </h2>
          <div id="collapse-${accordionId}" class="accordion-collapse collapse" ${parentAttribute}>
            <div class="accordion-body">`;

      if (hasChildren) {
        html += buildATUAccordion(node.children, accordionId, level + 1);
      } else {
        html += `<div id="types-${accordionId}">Loading...</div>`;
      }

      html += `
            </div>
          </div>
        </div>`;
    });

    html += '</div>';
    return html;
  }

  window.loadTypesInRange = function(typeRange, containerId) {
    const actualContainerId = containerId.replace('collapse-', '');
    const typesContainer = document.getElementById(`types-${actualContainerId}`);

    if (!typesContainer) {
      console.error(`Container not found: types-${actualContainerId}`);
      return;
    }

    fetch(`/get_types_in_range/${typeRange}`)
      .then(response => response.json())
      .then(data => {
        let html = '<ul class="list-unstyled">';
        data.forEach(type => {
          html += `<li><a href="#" onclick="loadBrowseTaleType('${type.type_id}')" class="text-decoration-none">
                     <strong>${type.type_id}</strong> – ${type.label}
                   </a></li>`;
        });
        html += '</ul>';
        typesContainer.innerHTML = html;
      })
      .catch(error => {
        console.error('Error loading types:', error);
        if (typesContainer) {
          typesContainer.innerHTML = '<p>Error loading tale types.</p>';
        }
      });
  };

  window.loadBrowseTaleType = function(typeId) {
    // Load tale type details in the browse results area
    loadBrowseTaleTypeDetails(typeId);
  };

  function loadBrowseTaleTypeDetails(typeId) {
    Promise.all([
      $.get(`/get_type_details/${typeId}`),
      $.get(`/get_motifs_for_type/${typeId}`)
    ]).then(([typeDetails, motifs]) => {
      displayBrowseTaleTypeResult(typeId, typeDetails, motifs);
    }).catch(() => {
      $('#browseResultContent').html('<p class="text-danger">Error loading tale type details</p>');
    });
  }

  function displayBrowseTaleTypeResult(typeId, details, motifs) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
    }

    let html = `
      <div class="result-item">
        <h5>ATU ${typeId} - ${details.label} ${culturalRefs}</h5>
        <p>${details.text || ''}</p>
        
        <div class="motif-list">
          <h6>Motifs:</h6>
    `;

    motifs.forEach(motif => {
      let motifCulturalRefs = '';
      if (motif.ref_terms && motif.ref_terms.trim()) {
        motifCulturalRefs = ` <span class="cultural-refs">[${motif.ref_terms}]</span>`;
      }
      html += `<div class="motif-item">
                 <span class="clickable-motif" onclick="loadMotifModalFromTaleType('${motif.motif_id}', '${typeId}')">
                   <strong>${motif.motif_id}</strong> ${motif.text}
                 </span>${motifCulturalRefs}
               </div>`;
    });
    html += '</div></div>';
    $('#browseResultContent').html(html);
  }

  // Hide search results when clicking outside
  $(document).click(function(e) {
    if (!$(e.target).closest('.search-container').length) {
      $('#searchResults').hide();
    }
  });

  // Modal helper functions
  window.showModalDetails = function(title, content) {
    $('#crossReferenceModalLabel').text(title);
    $('#crossReferenceModalBody').html(content);
    const modal = new bootstrap.Modal(document.getElementById('crossReferenceModal'));
    modal.show();
  }

  window.loadTaleTypeModal = function(typeId) {
    Promise.all([
      $.get(`/get_type_details/${typeId}`),
      $.get(`/get_motifs_for_type/${typeId}`)
    ]).then(([typeDetails, motifs]) => {
      const content = generateTaleTypeModalContent(typeId, typeDetails, motifs);
      showModalDetails(`ATU ${typeId} - ${typeDetails.label}`, content);
    }).catch(() => {
      showModalDetails('Error', '<p class="text-danger">Error loading tale type details</p>');
    });
  }

  window.loadMotifModal = function(motifId) {
    Promise.all([
      $.get(`/get_motif_details/${motifId}`),
      $.get(`/get_types_for_motif/${motifId}`)
    ]).then(([motifDetails, types]) => {
      const content = generateMotifModalContent(motifId, motifDetails, types);
      showModalDetails(`TMI ${motifId}`, content);
    }).catch(() => {
      showModalDetails('Error', '<p class="text-danger">Error loading motif details</p>');
    });
  }

  window.loadMotifModalFromTaleType = function(motifId, excludeTypeId) {
    console.log(`loadMotifModalFromTaleType called with motifId: ${motifId}, excludeTypeId: ${excludeTypeId}`);
    Promise.all([
      $.get(`/get_motif_details/${motifId}`),
      $.get(`/get_types_for_motif/${motifId}`)
    ]).then(([motifDetails, types]) => {
      const content = generateMotifModalContent(motifId, motifDetails, types, excludeTypeId);
      showModalDetails(`TMI ${motifId}`, content);
    }).catch(() => {
      showModalDetails('Error', '<p class="text-danger">Error loading motif details</p>');
    });

  };

  function generateTaleTypeModalContent(typeId, details, motifs) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
    }

    let content = `
      <div class="modal-tale-type">
        <h6>ATU ${typeId} - ${details.label} ${culturalRefs}</h6>
        <p>${details.text || ''}</p>
        <div class="motif-list">
          <h6>Motifs:</h6>
    `;

    motifs.forEach(motif => {
      let motifCulturalRefs = '';
      if (motif.ref_terms && motif.ref_terms.trim()) {
        motifCulturalRefs = ` <span class="cultural-refs">[${motif.ref_terms}]</span>`;
      }
      content += `<div class="motif-item">
                    <span class="clickable-motif" onclick="loadMotifModalFromTaleType('${motif.motif_id}', '${typeId}')">
                      <strong>${motif.motif_id}</strong> ${motif.text}
                    </span>${motifCulturalRefs}
                  </div>`;
    });

    content += '</div></div>';
    return content;
  }

  function generateMotifModalContent(motifId, details, types, excludeTypeId = null) {
  console.log(`generateMotifModalContent called with motifId: ${motifId}, excludeTypeId: ${excludeTypeId}`);
  console.log('All types:', types.map(t => t.type_id));

  let culturalRefs = '';
  if (details.ref_terms && details.ref_terms.length > 0) {
    const terms = details.ref_terms.slice(0, 5);
    const remaining = details.ref_terms.length - 5;
    culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
  }

  // Filter out the excluded tale type if specified
  const filteredTypes = excludeTypeId ?
    types.filter(type => {
      console.log(`Comparing type.type_id: '${type.type_id}' with excludeTypeId: '${excludeTypeId}'`);
      return type.type_id !== excludeTypeId;
    }) :
    types;

  console.log('Filtered types:', filteredTypes.map(t => t.type_id));

  let content = `
    <div class="modal-motif">
      <h6>TMI ${motifId}: ${details.text} ${culturalRefs}</h6>
      <div class="motif-list">
        <h6>Other Tale Types (${filteredTypes.length}):</h6>
  `;

  if (filteredTypes.length === 0) {
    content += '<p class="text-muted">No other related tale types found.</p>';
  } else {
    filteredTypes.forEach(type => {
      let typeCulturalRefs = '';
      if (type.ref_terms && type.ref_terms.trim()) {
        typeCulturalRefs = ` <span class="cultural-refs">[${type.ref_terms}]</span>`;
      }
      content += `<div class="motif-item">
                    <span class="clickable-tale-type" onclick="loadTaleTypeModal('${type.type_id}')">
                      <strong>ATU ${type.type_id}</strong> – ${type.type_id !== excludeTypeId ? type.label : 'SHOULD BE FILTERED'}
                    </span>${typeCulturalRefs}
                  </div>`;
    });
  }

  content += '</div></div>';
  return content;
}

  // Initialize
  updateIndexHeader();
  updateDirectionArrow();
  updateBrowseDisplay();

  // Force initial tab
  const initialTab = $('.tab-button.active').data('tab');
  if (initialTab) {
    $('.tab-button[data-tab="' + initialTab + '"]').trigger('click');
  }
});
</script>

</body>
</html>