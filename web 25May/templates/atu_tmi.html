<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLOS::ATU<>TMI</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="../static/css/styles.css" rel="stylesheet">
</head>
<body>
<div class="container">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">GLOS</a>
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/explore">Explore</a></li>
          <li class="nav-item"><a class="nav-link" href="/atu_tmi">ATU&lt;&gt;TMI</a></li>
          <li class="nav-item"><a class="nav-link" href="/mapping">Mapping</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="row mt-4">
    <div class="col-md-5">
      <h5 class="bg-light ps-1">Browse Tale Types</h5>
      <div id="atuHierarchy">
        <!-- Accordion will be populated here -->
      </div>
    </div>
    <!--    <div class="col-md-5">-->
<!--      <h5 class="bg-light ps-1">Select Tale Type</h5>-->
<!--      <div>-->
<!--        <form id="atuForm">-->
<!--          <div class="form-group">-->
<!--            <label for="typeSelect">ATU Tale Type:</label>-->
<!--            <select class="form-select" id="typeSelect" name="typeSelect">-->
<!--              {% for type_id, label in tale_types %}-->
<!--                <option value="{{ type_id }}">{{ type_id }} – {{ label }}</option>-->
<!--              {% endfor %}-->
<!--            </select>-->
<!--          </div>-->
<!--          <button type="button" class="btn btn-primary mt-2" onclick="loadMotifs()">Show Motifs</button>-->
<!--        </form>-->
<!--      </div>-->
<!--    </div>-->

    <div class="col-md-7">
      <h5 class="bg-light ps-1">Motifs</h5>
      <div id="result"></div>
    </div>
  </div>
</div>

<script>
// Load hierarchy on page load
document.addEventListener('DOMContentLoaded', function() {
  loadATUHierarchy();
});

function loadATUHierarchy() {
  fetch('/get_atu_hierarchy')
    .then(response => response.json())
    .then(data => {
      const hierarchyDiv = document.getElementById('atuHierarchy');
      hierarchyDiv.innerHTML = buildAccordion(data, 'accordion-root');
    });
}

function buildAccordion(nodes, parentId, level = 0) {
  let html = `<div class="accordion" id="${parentId}">`;

  nodes.forEach((node, index) => {
    const accordionId = `${parentId}-${index}`;
    const hasChildren = node.children && node.children.length > 0;

    // Add data-bs-parent only for top-level accordions (level 0)
    const parentAttribute = level === 0 ? `data-bs-parent="#${parentId}"` : '';

    html += `
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}"
                  ${parentAttribute}
                  ${hasChildren ? '' : `onclick="loadTypesInRange('${node.type_range}', 'collapse-${accordionId}')"`}>
            ${node.label} (${node.type_range})
          </button>
        </h2>
        <div id="collapse-${accordionId}" class="accordion-collapse collapse" ${parentAttribute}>
          <div class="accordion-body">`;

    if (hasChildren) {
      // Recursive call for nested accordions (these won't have the parent restriction)
      html += buildAccordion(node.children, accordionId, level + 1);
    } else {
      html += `<div id="types-${accordionId}">Loading...</div>`;
    }

    html += `
          </div>
        </div>
      </div>`;
  });

  html += '</div>';
  return html;
}

// function buildAccordion(nodes, parentId, level = 0) {
//   let html = `<div class="accordion" id="${parentId}">`;
//
//   nodes.forEach((node, index) => {
//     const accordionId = `${parentId}-${index}`;
//     const hasChildren = node.children && node.children.length > 0;
//
//     html += `
//       <div class="accordion-item">
//         <h2 class="accordion-header">
//           <button class="accordion-button collapsed" type="button"
//                   data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}"
//                   ${hasChildren ? '' : `onclick="loadTypesInRange('${node.type_range}', 'collapse-${accordionId}')"`}>
//             ${node.label} (${node.type_range})
//           </button>
//         </h2>
//         <div id="collapse-${accordionId}" class="accordion-collapse collapse">
//           <div class="accordion-body">`;
//
//     if (hasChildren) {
//       // Recursive call for nested accordions
//       html += buildAccordion(node.children, accordionId, level + 1);
//     } else {
//       // This will be populated with tale types when clicked
//       html += `<div id="types-${accordionId}">Loading...</div>`;
//     }
//
//     html += `
//           </div>
//         </div>
//       </div>`;
//   });
//
//   html += '</div>';
//   return html;
// }


function loadTypesInRange(typeRange, containerId) {
  // Remove the 'collapse-' prefix to get the actual container ID
  const actualContainerId = containerId.replace('collapse-', '');
  const typesContainer = document.getElementById(`types-${actualContainerId}`);

  if (!typesContainer) {
    console.error(`Container not found: types-${actualContainerId}`);
    return;
  }

  fetch(`/get_types_in_range/${typeRange}`)
    .then(response => response.json())
    .then(data => {
      let html = '<ul class="list-unstyled">';
      data.forEach(type => {
        html += `<li><a href="#" onclick="loadMotifsForType('${type.type_id}')" class="text-decoration-none">
                   <strong>${type.type_id}</strong> – ${type.label}
                 </a></li>`;
      });
      html += '</ul>';
      typesContainer.innerHTML = html;
    })
    .catch(error => {
      console.error('Error loading types:', error);
      if (typesContainer) {
        typesContainer.innerHTML = '<p>Error loading tale types.</p>';
      }
    });
}

function loadMotifsForType(typeId) {
    // First get the type details
    fetch(`/get_type_details/${typeId}`)
        .then(response => response.json())
        .then(typeDetails => {
            console.log('Type details:', typeDetails); // Debug line

            // Then get the motifs
            fetch('/get_motifs_for_type/' + typeId)
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('result');
                    if (data.length === 0) {
                        resultDiv.innerHTML = '<p>No motifs found for this tale type.</p>';
                        return;
                    }

                    // Build cultural references display
                    let culturalRefs = '';
                    if (typeDetails.ref_terms && typeDetails.ref_terms.length > 0) {
                        const refTerms = typeDetails.ref_terms;
                        if (refTerms.length <= 5) {
                            culturalRefs = ` <strong>[${refTerms.join(', ')}]</strong>`;
                        } else {
                            const displayTerms = refTerms.slice(0, 5);
                            const remainingCount = refTerms.length - 5;
                            // Store the full list in a data attribute and use a simpler onclick
                            culturalRefs = ` <strong>[${displayTerms.join(', ')}, <a href="#" class="show-refs-link" data-type-id="${typeId}" data-type-label="${typeDetails.label}" data-ref-terms='${JSON.stringify(refTerms)}'>...+${remainingCount} more</a>]</strong>`;
                        }
                    }

                    // Build the HTML
                    let html = `<h6>ATU ${typeId} – ${typeDetails.label}${culturalRefs}</h6>`;

                    // Add the tale type text if it exists
                    if (typeDetails.text && typeDetails.text.trim() !== '') {
                        html += `<div class="mb-3 p-2 bg-light rounded"><small>${typeDetails.text}</small></div>`;
                    }

                    html += '<h6>Motifs:</h6><ul>';
                    data.forEach(m => {
                        html += `<li><strong>${m.motif_id}</strong>: ${m.text}`;
                        if (m.ref_terms && m.ref_terms.trim() !== '') {
                            html += ` <strong>[${m.ref_terms}]</strong>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';

                    resultDiv.innerHTML = html;

                    // Add event listener for the "show more" links
                    document.querySelectorAll('.show-refs-link').forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const typeId = this.dataset.typeId;
                            const typeLabel = this.dataset.typeLabel;
                            const refTerms = JSON.parse(this.dataset.refTerms);
                            showAllReferences(typeId, typeLabel, refTerms);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading motifs:', error);
                    document.getElementById('result').innerHTML = '<p>Error loading motifs.</p>';
                });
        })
        .catch(error => {
            console.error('Error loading type details:', error);
            document.getElementById('result').innerHTML = '<p>Error loading tale type details.</p>';
        });
}

function showAllReferences(typeId, typeLabel, refTerms) {
    const modalHtml = `
        <div class="modal fade" id="referencesModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Cultural References for ATU ${typeId}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>${typeLabel}</h6>
                        <p><strong>${refTerms.length} cultural references:</strong></p>
                        <div class="bg-light p-2 rounded" style="max-height: 300px; overflow-y: auto;">
                            <small>${refTerms.join(', ')}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

    // Remove existing modal if any
    const existingModal = document.getElementById('referencesModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('referencesModal'));
    modal.show();

    // Clean up modal after it's hidden
    document.getElementById('referencesModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}
</script>
</body>
</html>
