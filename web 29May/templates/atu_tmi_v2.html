<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLOS::ATU<>TMI v2</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="../static/css/styles.css" rel="stylesheet">
  <style>
    .search-results {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      background: white;
      position: absolute;
      width: 100%;
      z-index: 1000;
      margin-top: 2px;
    }
    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    .search-result-item:hover {
      background-color: #f8f9fa;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-container {
      position: relative;
    }
    .mode-selector {
      margin-bottom: 15px;
    }
    .mode-selector .form-check {
      display: inline-block;
      margin-right: 30px;
    }
    .mode-selector .form-check-input:checked {
      background-color: #dc3545;
      border-color: #dc3545;
    }
    .tab-buttons {
      margin-bottom: 20px;
    }
    .tab-button {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-bottom: none;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-block;
      margin-right: 2px;
    }
    .tab-button.active {
      background: white;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
    }
    .content-area {
      border: 1px solid #dee2e6;
      background: white;
      min-height: 500px;
    }
    .search-content, .browse-content {
      padding: 20px;
    }
    .browse-content {
      display: none;
    }
    .result-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .cultural-refs {
      color: #666;
      font-size: 0.9em;
    }
    .motif-list {
      margin-top: 15px;
    }
    .motif-item {
      margin-bottom: 8px;
    }
    .motif-category-item {
      cursor: pointer;
      padding: 8px 12px;
      border-bottom: 1px solid #dee2e6;
    }
    .motif-category-item:hover {
      background-color: #f8f9fa;
    }
    .cross-reference {
      margin-top: 10px;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">GLOS</a>
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/explore">Explore</a></li>
          <li class="nav-item"><a class="nav-link" href="/atu_tmi">ATU&lt;&gt;TMI</a></li>
          <li class="nav-item"><a class="nav-link" href="/atu_tmi_v2">ATU&lt;&gt;TMI v2</a></li>
          <li class="nav-item"><a class="nav-link" href="/mapping">Mapping</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <h4>ATU &lt;-&gt; TMI 
          <i class="fas fa-question-circle" data-bs-toggle="tooltip" 
             title="Cross-reference between Aarne-Thompson-Uther tale types and Thompson motif index"></i>
        </h4>
      </div>
    </div>

    <!-- Tab buttons -->
    <div class="tab-buttons">
      <div class="tab-button active" data-tab="search">Search</div>
      <div class="tab-button" data-tab="browse">Browse</div>
    </div>

    <!-- Content area -->
    <div class="content-area">
      
      <!-- Search tab content -->
      <div class="search-content">
        <div class="row">
          <!-- Left side: Search -->
          <div class="col-md-5">
            <!-- Radio buttons above search -->
            <div class="mode-selector mb-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="searchMode" id="atuMode" value="atu" checked>
                <label class="form-check-label" for="atuMode">
                  ATU tale types
                </label>
              </div>
              <span class="mx-2" style="color: #dc3545;">▶</span>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="searchMode" id="tmiMode" value="tmi">
                <label class="form-check-label" for="tmiMode">
                  Thompson motifs
                </label>
              </div>
            </div>
            
            <div class="search-container">
              <input type="text" class="form-control form-control-lg" id="searchInput" 
                     placeholder="Search..." autocomplete="off">
              <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>
          </div>
          
          <!-- Right side: Results -->
          <div class="col-md-7">
            <div id="resultArea">
              <div id="indexHeader" class="mb-3">
                <h5 id="indexTitle">The Types of International Folktales (ATU)</h5>
              </div>
              <div id="resultContent">
                <p class="text-muted">Start typing to search for tale types or motifs...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Browse tab content -->
      <div class="browse-content">
        <div class="row">
          <div class="col-md-5">
            <div class="mode-selector mb-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="browseMode" id="browseAtuMode" value="atu" checked>
                <label class="form-check-label" for="browseAtuMode">
                  ATU tale types
                </label>
              </div>
              <span class="mx-2" style="color: #dc3545;">▶</span>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="browseMode" id="browseTmiMode" value="tmi">
                <label class="form-check-label" for="browseTmiMode">
                  Thompson motifs
                </label>
              </div>
            </div>
            
            <div id="browseHierarchy">
              <div id="atuHierarchy">
                <p class="text-muted">Loading ATU hierarchy...</p>
              </div>
              <div id="tmiHierarchy" style="display: none;">
                <p class="text-muted">TMI hierarchy coming soon...</p>
              </div>
            </div>
          </div>
          <div class="col-md-7">
            <div id="browseResults">
              <div id="browseIndexHeader" class="mb-3">
                <h5 id="browseIndexTitle">The Types of International Folktales (ATU)</h5>
              </div>
              <div id="browseResultContent">
                <p class="text-muted">Select a category to browse...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  let searchTimeout;
  let currentMode = 'atu';
  let browseMode = 'atu';
  let atuHierarchyLoaded = false;
  let tmiHierarchyLoaded = false;

  // Tab switching
  $('.tab-button').click(function() {
    const tab = $(this).data('tab');
    
    // Update tab appearance
    $('.tab-button').removeClass('active');
    $(this).addClass('active');
    
    // Show/hide content
    if (tab === 'search') {
      $('.search-content').show();
      $('.browse-content').hide();
    } else {
      $('.search-content').hide();
      $('.browse-content').show();
      // Load browse content if not already loaded
      if ($('#atuHierarchy').html().includes('Loading')) {
        loadATUHierarchy();
      }
    }
  });

  // Browse mode radio buttons
  $('input[name="browseMode"]').change(function() {
    browseMode = $(this).val();
    updateBrowseDisplay();
  });

  function updateBrowseDisplay() {
    if (browseMode === 'atu') {
      $('#browseIndexTitle').text('The Types of International Folktales (ATU)');
      $('#atuHierarchy').show();
      $('#tmiHierarchy').hide();
      $('.browse-content .mode-selector span').html('▶').css('color', '#dc3545');

      // Load ATU hierarchy if not already loaded
      if (!atuHierarchyLoaded) {
        loadATUHierarchy();
      }
    } else {
      $('#browseIndexTitle').text('Thompson Motif-Index (TMI)');
      $('#atuHierarchy').hide();
      $('#tmiHierarchy').show();
      $('.browse-content .mode-selector span').html('◀').css('color', '#0d6efd');

      // Load TMI hierarchy if not already loaded
      if (!tmiHierarchyLoaded) {
        loadTMIHierarchy();
      }
    }

    // Clear browse results when switching modes
    $('#browseResultContent').html('<p class="text-muted">Select a category to browse...</p>');
  }

  // Radio button handling for search
  $('input[name="searchMode"]').change(function() {
    currentMode = $(this).val();
    updateIndexHeader();
    updateDirectionArrow();
    clearResults();
    $('#searchInput').val('').focus();
  });

  function updateDirectionArrow() {
    const arrow = $('.search-content .mode-selector span');
    if (currentMode === 'atu') {
      arrow.html('▶').css('color', '#dc3545');
    } else {
      arrow.html('◀').css('color', '#0d6efd');
    }
  }

  function updateIndexHeader() {
    if (currentMode === 'atu') {
      $('#indexTitle').text('The Types of International Folktales (ATU)');
      $('#searchInput').attr('placeholder', 'Search tale types...');
    } else {
      $('#indexTitle').text('Thompson Motif-Index (TMI)');
      $('#searchInput').attr('placeholder', 'Search motifs...');
    }
  }

  function clearResults() {
    $('#searchResults').hide();
    if (currentMode === 'atu') {
      $('#resultContent').html('<p class="text-muted">Start typing to search for tale types - either a word or ATU ID - then select one to find related TMI motifs...</p>');
    } else {
      $('#resultContent').html('<p class="text-muted">Start typing to search for motifs - either a work or TMI ID - then select one to find related tale types referenced in the ATU...</p>');
    }
  }

  // Search functionality
  $('#searchInput').on('input', function() {
    const query = $(this).val().trim();
    
    if (query.length < 2) {
      $('#searchResults').hide();
      return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      performSearch(query);
    }, 300);
  });

  function performSearch(query) {
    const endpoint = currentMode === 'atu' ? '/search_types' : '/search_motifs';
    
    $.get(`${endpoint}?q=${encodeURIComponent(query)}&limit=10`)
      .done(function(data) {
        displaySearchResults(data);
      })
      .fail(function() {
        $('#searchResults').html('<div class="search-result-item text-danger">Search error</div>').show();
      });
  }

  function displaySearchResults(data) {
    if (data.length === 0) {
      $('#searchResults').html('<div class="search-result-item">No results found</div>').show();
      return;
    }

    let html = '';
    data.forEach(item => {
      if (currentMode === 'atu') {
        html += `<div class="search-result-item" onclick="selectTaleType('${item.type_id}')">
                   <strong>ATU ${item.type_id}</strong> – ${item.label}
                 </div>`;
      } else {
        html += `<div class="search-result-item" onclick="selectMotif('${item.motif_id}')">
                   <strong>${item.motif_id}</strong>: ${item.text.substring(0, 80)}${item.text.length > 80 ? '...' : ''}
                   <span class="badge bg-primary float-end">${item.type_count || 0}</span>
                 </div>`;
      }
    });
    
    $('#searchResults').html(html).show();
  }

  // Selection handlers
  window.selectTaleType = function(typeId) {
    $('#searchResults').hide();
    loadTaleTypeDetails(typeId);
  };

  window.selectMotif = function(motifId) {
    $('#searchResults').hide();
    loadMotifDetails(motifId);
  };

  function loadTaleTypeDetails(typeId) {
    // Get tale type details and its motifs
    Promise.all([
      $.get(`/get_type_details/${typeId}`),
      $.get(`/get_motifs_for_type/${typeId}`)
    ]).then(([typeDetails, motifs]) => {
      // Update search input with ID - Label format
      $('#searchInput').val(`${typeId} - ${typeDetails.label}`);
      displayTaleTypeResult(typeId, typeDetails, motifs);
    }).catch(() => {
      $('#resultContent').html('<p class="text-danger">Error loading tale type details</p>');
    });
  }

  function loadMotifDetails(motifId) {
    // Get motif details and its tale types
    Promise.all([
      $.get(`/get_motif_details/${motifId}`),
      $.get(`/get_types_for_motif/${motifId}`)
    ]).then(([motifDetails, types]) => {
      // Update search input with ID - Label format
      $('#searchInput').val(`${motifId} - ${motifDetails.text.substring(0, 50)}${motifDetails.text.length > 50 ? '...' : ''}`);
      displayMotifResult(motifId, motifDetails, types);
    }).catch(() => {
      $('#resultContent').html('<p class="text-danger">Error loading motif details</p>');
    });
  }

  function displayTaleTypeResult(typeId, details, motifs) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
    }

    let html = `
      <div class="result-item">
        <h5>ATU ${typeId} - ${details.label} ${culturalRefs}</h5>
        <p>${details.text || ''}</p>
        
        <div class="motif-list">
          <h6>Motifs:</h6>
    `;

    motifs.forEach(motif => {
      let motifCulturalRefs = '';
      if (motif.ref_terms && motif.ref_terms.trim()) {
        motifCulturalRefs = ` <span class="cultural-refs">[${motif.ref_terms}]</span>`;
      }
      html += `<div class="motif-item">
                 <strong>${motif.motif_id}</strong> ${motif.text}${motifCulturalRefs}
               </div>`;
    });

    html += '</div></div>';
    $('#resultContent').html(html);
  }

  function displayMotifResult(motifId, details, types) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
    }

    let html = `
      <div class="result-item">
        <h5>TMI ${motifId}: ${details.text} ${culturalRefs}</h5>
        
        <div class="motif-list">
          <h6>Tale Types (${types.length}):</h6>
    `;

    types.forEach(type => {
      let typeCulturalRefs = '';
      if (type.ref_terms && type.ref_terms.trim()) {
        typeCulturalRefs = ` <span class="cultural-refs">[${type.ref_terms}]</span>`;
      }
      html += `<div class="motif-item">
                 <a href="#" onclick="selectTaleType('${type.type_id}')" class="text-decoration-none">
                   <strong>ATU ${type.type_id}</strong> – ${type.label}${typeCulturalRefs}
                 </a>
               </div>`;
    });

    // Add cross-reference logic here for multiple tale types
    if (types.length > 1) {
      html += `<div class="cross-reference">
                 Also appears in ${types.length} tale types
               </div>`;
    }

    html += '</div></div>';
    $('#resultContent').html(html);
  }

  // Load ATU hierarchy for browse tab
  function loadATUHierarchy() {
    fetch('/get_atu_hierarchy')
      .then(response => response.json())
      .then(data => {
        const hierarchyHtml = buildATUAccordion(data, 'browse-accordion-root');
        $('#atuHierarchy').html(hierarchyHtml);
        atuHierarchyLoaded = true;
      })
      .catch(error => {
        console.error('Error loading ATU hierarchy:', error);
        $('#atuHierarchy').html('<p class="text-danger">Error loading hierarchy</p>');
      });
  }

  function buildATUAccordion(nodes, parentId, level = 0) {
    let html = `<div class="accordion" id="${parentId}">`;

    nodes.forEach((node, index) => {
      const accordionId = `${parentId}-${index}`;
      const hasChildren = node.children && node.children.length > 0;
      const parentAttribute = level === 0 ? `data-bs-parent="#${parentId}"` : '';

      html += `
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}"
                    ${parentAttribute}
                    ${hasChildren ? '' : `onclick="loadTypesInRange('${node.type_range}', 'collapse-${accordionId}')"`}>
              ${node.label} (${node.type_range})
            </button>
          </h2>
          <div id="collapse-${accordionId}" class="accordion-collapse collapse" ${parentAttribute}>
            <div class="accordion-body">`;

      if (hasChildren) {
        html += buildATUAccordion(node.children, accordionId, level + 1);
      } else {
        html += `<div id="types-${accordionId}">Loading...</div>`;
      }

      html += `
            </div>
          </div>
        </div>`;
    });

    html += '</div>';
    return html;
  }

  window.loadTypesInRange = function(typeRange, containerId) {
    const actualContainerId = containerId.replace('collapse-', '');
    const typesContainer = document.getElementById(`types-${actualContainerId}`);

    if (!typesContainer) {
      console.error(`Container not found: types-${actualContainerId}`);
      return;
    }

    fetch(`/get_types_in_range/${typeRange}`)
      .then(response => response.json())
      .then(data => {
        let html = '<ul class="list-unstyled">';
        data.forEach(type => {
          html += `<li><a href="#" onclick="loadBrowseTaleType('${type.type_id}')" class="text-decoration-none">
                     <strong>${type.type_id}</strong> – ${type.label}
                   </a></li>`;
        });
        html += '</ul>';
        typesContainer.innerHTML = html;
      })
      .catch(error => {
        console.error('Error loading types:', error);
        if (typesContainer) {
          typesContainer.innerHTML = '<p>Error loading tale types.</p>';
        }
      });
  };

  window.loadBrowseTaleType = function(typeId) {
    // Load tale type details in the browse results area
    loadBrowseTaleTypeDetails(typeId);
  };

  function loadBrowseTaleTypeDetails(typeId) {
    Promise.all([
      $.get(`/get_type_details/${typeId}`),
      $.get(`/get_motifs_for_type/${typeId}`)
    ]).then(([typeDetails, motifs]) => {
      displayBrowseTaleTypeResult(typeId, typeDetails, motifs);
    }).catch(() => {
      $('#browseResultContent').html('<p class="text-danger">Error loading tale type details</p>');
    });
  }

  function displayBrowseTaleTypeResult(typeId, details, motifs) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
    }

    let html = `
      <div class="result-item">
        <h5>ATU ${typeId} - ${details.label} ${culturalRefs}</h5>
        <p>${details.text || ''}</p>
        
        <div class="motif-list">
          <h6>Motifs:</h6>
    `;

    motifs.forEach(motif => {
      let motifCulturalRefs = '';
      if (motif.ref_terms && motif.ref_terms.trim()) {
        motifCulturalRefs = ` <span class="cultural-refs">[${motif.ref_terms}]</span>`;
      }
      html += `<div class="motif-item">
                 <strong>${motif.motif_id}</strong> ${motif.text}${motifCulturalRefs}
               </div>`;
    });

    html += '</div></div>';
    $('#browseResultContent').html(html);
  }

  // TMI hierarchy loading
  window.loadTMIHierarchy = function() {
    $('#tmiHierarchy').html('<p class="text-muted">Loading TMI categories...</p>');

    fetch('/get_tmi_categories')
      .then(response => response.json())
      .then(data => {
        console.log('TMI categories received:', data.length, 'categories');
        let html = '<div class="list-group">';

        data.forEach(category => {
          html += `
            <div class="motif-category-item list-group-item d-flex justify-content-between align-items-center"
                 onclick="loadTMIRanges('${category.category}')">
              <div>
                <strong>${category.category}:</strong> ${category.description}
              </div>
              <span class="badge bg-primary rounded-pill">${category.connected_count} of ${category.total_count}</span>
            </div>`;
        });

        html += '</div>';
        $('#tmiHierarchy').html(html);
        tmiHierarchyLoaded = true;
      })
      .catch(error => {
        console.error('Error loading TMI categories:', error);
        $('#tmiHierarchy').html('<p class="text-danger">Error loading motif categories</p>');
      });
  };

  // FIXED: This function now correctly uses the passed category parameter
  window.loadTMIRanges = function(category) {
    console.log('Loading TMI ranges for category:', category); // Debug log
    $('#tmiHierarchy').html('<p class="text-muted">Loading ranges...</p>');

    fetch(`/get_tmi_ranges/${category}`)
      .then(response => response.json())
      .then(data => {
        let html = `<div class="mb-2">
          <button class="btn btn-sm btn-outline-secondary" onclick="loadTMIHierarchy()">
            ← Back to Categories
          </button>
        </div>`;
        html += `<h6>Category ${category} Ranges</h6>`;
        html += '<div class="list-group">';

        data.forEach(range => {
          html += `
            <div class="motif-category-item list-group-item d-flex justify-content-between align-items-center"
                 onclick="loadTMISubRanges('${range.range_id}')">
              <div>
                <strong>${range.range_id}:</strong> ${range.label}
              </div>
              <span class="badge bg-secondary rounded-pill">${range.connected_count} of ${range.total_count}</span>
            </div>`;
        });

        html += '</div>';
        $('#tmiHierarchy').html(html);
      })
      .catch(error => {
        console.error('Error loading TMI ranges:', error);
        $('#tmiHierarchy').html('<p class="text-danger">Error loading ranges</p>');
      });
  };

  window.loadTMISubRanges = function(rangeId) {
    $('#tmiHierarchy').html('<p class="text-muted">Loading sub-ranges...</p>');

    fetch(`/get_tmi_subranges/${rangeId}`)
      .then(response => response.json())
      .then(data => {
        let html = `<div class="mb-2">
          <button class="btn btn-sm btn-outline-secondary" onclick="loadTMIRanges('${rangeId.charAt(0)}')">
            ← Back to ${rangeId.charAt(0)} Ranges
          </button>
        </div>`;

        if (data.length === 0) {
          // No sub-ranges, load motifs directly
          loadMotifsInRange(rangeId);
          return;
        }

        html += `<h6>${rangeId} Sub-ranges</h6>`;
        html += '<div class="list-group">';

        data.forEach(subrange => {
          html += `
            <div class="motif-category-item list-group-item d-flex justify-content-between align-items-center"
                 onclick="loadMotifsInRange('${subrange.range_id}')">
              <div>
                <strong>${subrange.range_id}:</strong> ${subrange.label}
              </div>
              <span class="badge bg-success rounded-pill">${subrange.connected_count} of ${subrange.total_count}</span>
            </div>`;
        });

        html += '</div>';
        $('#tmiHierarchy').html(html);
      })
      .catch(error => {
        console.error('Error loading TMI sub-ranges:', error);
        $('#tmiHierarchy').html('<p class="text-danger">Error loading sub-ranges</p>');
      });
  };

  window.loadMotifsInRange = function(rangeId) {
    // Update the left panel to show current location and back button
    let backCategory = rangeId.charAt(0);
    let html = `<div class="mb-2">
      <button class="btn btn-sm btn-outline-secondary" onclick="loadTMIHierarchy()">
        ← Back to Categories
      </button>
      <button class="btn btn-sm btn-outline-secondary ms-1" onclick="loadTMIRanges('${backCategory}')">
        ← Back to ${backCategory} Ranges
      </button>
    </div>`;
    html += `<h6>Showing motifs for: ${rangeId}</h6>`;
    html += `<p class="text-muted">Motifs are displayed in the right panel →</p>`;

    $('#tmiHierarchy').html(html);

    // Load motifs on the RIGHT panel
    $('#browseResultContent').html('<p class="text-muted">Loading motifs...</p>');

    fetch(`/get_motifs_in_range/${rangeId}?limit=100`)
      .then(response => response.json())
      .then(data => {
        let resultHtml = `<h6>Connected Motifs in ${rangeId}</h6>`;
        resultHtml += `<p class="text-muted">${data.total} motifs connected to ATU tale types</p>`;
        resultHtml += '<ul class="list-unstyled">';

        data.motifs.forEach(motif => {
          resultHtml += `<li class="mb-2">
            <a href="#" onclick="loadBrowseMotifDetail('${motif.motif_id}')" class="text-decoration-none">
              <strong>${motif.motif_id}</strong>: ${motif.text}
              <span class="badge bg-primary ms-2">${motif.type_count} tale types</span>
            </a>
          </li>`;
        });

        resultHtml += '</ul>';

        if (data.total > data.limit) {
          resultHtml += `<p class="text-muted">Showing first ${data.limit} of ${data.total} connected motifs</p>`;
        }

        $('#browseResultContent').html(resultHtml);
      })
      .catch(error => {
        console.error('Error loading motifs:', error);
        $('#browseResultContent').html('<p class="text-danger">Error loading motifs</p>');
      });
  };

  // Browse motif detail function
  window.loadBrowseMotifDetail = function(motifId) {
    $('#browseResultContent').html('<p class="text-muted">Loading motif details...</p>');

    Promise.all([
      fetch(`/get_motif_details/${motifId}`).then(r => r.json()),
      fetch(`/get_types_for_motif/${motifId}`).then(r => r.json())
    ]).then(([motifDetails, types]) => {
      displayBrowseMotifResult(motifId, motifDetails, types);
    }).catch(error => {
      console.error('Error loading motif details:', error);
      $('#browseResultContent').html('<p class="text-danger">Error loading motif details</p>');
    });
  };

  function displayBrowseMotifResult(motifId, details, types) {
    let culturalRefs = '';
    if (details.ref_terms && details.ref_terms.length > 0) {
      const terms = details.ref_terms.slice(0, 5);
      const remaining = details.ref_terms.length - 5;
      culturalRefs = `<span class="cultural-refs">[${terms.join(', ')}${remaining > 0 ? `, ...${remaining} more` : ''}]</span>`;
    }

    let html = `
      <div class="result-item">
        <h5>TMI ${motifId}: ${details.text} ${culturalRefs}</h5>

        <div class="motif-list">
          <h6>Tale Types (${types.length}):</h6>
    `;

    types.forEach(type => {
      let typeCulturalRefs = '';
      if (type.ref_terms && type.ref_terms.trim()) {
        typeCulturalRefs = ` <span class="cultural-refs">[${type.ref_terms}]</span>`;
      }
      html += `<div class="motif-item">
                 <a href="#" onclick="loadBrowseTaleType('${type.type_id}')" class="text-decoration-none">
                   <strong>ATU ${type.type_id}</strong> – ${type.label}${typeCulturalRefs}
                 </a>
               </div>`;
    });

    html += '</div></div>';
    $('#browseResultContent').html(html);
  }

  // Hide search results when clicking outside
  $(document).click(function(e) {
    if (!$(e.target).closest('.search-container').length) {
      $('#searchResults').hide();
    }
  });

  // Initialize
  updateIndexHeader();
  updateDirectionArrow();
  updateBrowseDisplay();
});
</script>

</body>
</html>